<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>English → Japanese Flashcards</title>

<!-- Swiper CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>

<style>
 body {
     margin: 0;
     font-family: -apple-system, BlinkMacSystemFont, sans-serif;
     background: #f4f6f9;
     display: flex;
     flex-direction: column;
     align-items: center;
     justify-content: center;
     height: 100vh;
 }

 h1 {
     font-size: 20px;
     margin-bottom: 10px;
     color: #333;
 }

 .swiper {
     width: 90%;
     max-width: 400px;
     height: 200px;
 }

 .swiper-slide {
     display: flex;
     align-items: center;
     justify-content: center;
 }

 .card {
     width: 100%;
     height: 100%;
     position: relative;
     transform-style: preserve-3d;
     transition: transform 0.6s;
 }

 .card.flipped {
     transform: rotateY(180deg);
 }

 .card-face {
     position: absolute;
     width: 100%;
     height: 100%;
     backface-visibility: hidden;
     display: flex;
     align-items: center;
     justify-content: center;
     text-align: center;
     white-space: pre-line;
     font-size: 32px;
     border-radius: 16px;
     box-shadow: 0 6px 20px rgba(0,0,0,0.1);
     background: white;
 }

 .card-back {
     transform: rotateY(180deg);
     background: #e6f0ff;
 }

 .controls {
     margin-top: 20px;
     width: 90%;
     max-width: 400px;
     display: flex;
     flex-direction: column;
     gap: 10px;
 }

 #chapterSelect {
     padding: 14px;
     font-size: 18px;
     border-radius: 12px;
     border: none;
     background: white;
     box-shadow: 0 6px 20px rgba(0,0,0,0.1);
 }

 button {
     padding: 14px;
     font-size: 16px;
     border: none;
     border-radius: 12px;
     background: #4a90e2;
     color: white;
     cursor: pointer;
 }

 button:active {
     transform: scale(0.98);
 }

 .progress {
     margin-top: 15px;
     font-size: 14px;
     color: #555;
 }

 .description {
     font-size: 18px;
     margin-top: 8px;
     color: #555;
 }
</style>
</head>

<body>

<h1>English → Japanese</h1>

<!-- Swiper Container -->
<div class="swiper mySwiper">
    <div class="swiper-wrapper" id="swiperWrapper">
        <!-- Slides generated dynamically -->
    </div>
</div>

<div class="progress" id="progress"></div>

<div class="controls">
    <select id="chapterSelect" onchange="changeChapter()"></select>
    <button onclick="shuffleDeck()">Shuffle</button>
    <label style="font-size:14px; display:flex; flex-direction:column; gap:6px;">
        <div>Auto flip delay</div>
        <div style="display:flex; align-items:center; gap:10px;">
            <input type="range" id="flipDelaySlider"
                   min="0" max="5000" step="500" value="0"
                   style="flex:1;">
            <span id="flipDelayLabel">OFF</span>
        </div>
    </label>

</div>

<audio id="audioPlayer"></audio>

<script src="https://unpkg.com/wanakana"></script>
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

<script>
 let allChapters = {}; // store words by chapter
 let words = [];       // words of current chapter
 let currentChapter = 0;
 let autoFlipTimeout = null;
 let swiper;
 const audioPlayer = document.getElementById("audioPlayer");
 const chapterSelect = document.getElementById("chapterSelect");

 const flipDelaySlider = document.getElementById("flipDelaySlider");
 const flipDelayLabel = document.getElementById("flipDelayLabel");
 flipDelaySlider.addEventListener("input", () => {
     const delay = parseInt(flipDelaySlider.value);

     if (delay === 0) {
         flipDelayLabel.innerText = "OFF";
         clearTimeout(autoFlipTimeout);
     } else {
         flipDelayLabel.innerText = (delay / 1000).toFixed(1) + "s";
         triggerAutoFlip();
     }
 });

 fetch("words.txt")
     .then(res => res.text())
     .then(text => {
         let currentKey = null;

         text.split("\n").forEach(line => {
             line = line.trim();
             if (!line || line.startsWith("#")) return; // skip empty or comment

             const chapterMatch = line.match(/^\[(.+?)\]/); // match [Chapter 0], [Basics], etc.
             if (chapterMatch) {
                 currentKey = chapterMatch[1];
                 allChapters[currentKey] = [];
             } else if (currentKey !== null) {
                 const parts = line
                     .split(/(?<!\\),/) // split on comma not preceded by a backslash
                     .map(p => p.replace(/\\,/g, ",") // unescape commas
                                .trim());

                 let english = parts[0] || "";
                 let description = "";

                 // Check if there is parentheses in the text
                 const match = english.match(/^(.*?)\s*\((.*?)\)\s*$/);
                 if (match) {
                     english = match[1].trim();     // text before parentheses
                     description = match[2].trim(); // text inside parentheses
                 }

                 allChapters[currentKey].push({
                     english: english,
                     japanese: parts[1] || "",
                     romaji: parts[2] || wanakana.toRomaji(parts[1]),
                     audio: parts[3] || "",
                     description: description
                 });
             }
         });
         populateChapterDropdown();
         // Select the first chapter by default
         const firstChapter = Object.keys(allChapters)[0];
         setChapter(firstChapter);
     });

 function populateChapterDropdown() {
     chapterSelect.innerHTML = ""; // clear existing options
     Object.keys(allChapters).forEach(chapterName => {
         const option = document.createElement("option");
         option.value = chapterName;
         option.innerText = chapterName;
         chapterSelect.appendChild(option);
     });
 }

 function getCurrentIndex() {
    return swiper ? swiper.realIndex : 0;
 }

 function setChapter(chapterName) {
     currentChapter = chapterName;
     words = allChapters[chapterName] ? [...allChapters[chapterName]] : [];
     //shuffleArray(words);
     generateSlides();
     chapterSelect.value = chapterName;
 }

 function changeChapter() {
     setChapter(chapterSelect.value);
 }

 function shuffleArray(array) {
     for (let i = array.length - 1; i > 0; i--) {
         const j = Math.floor(Math.random() * (i + 1));
         [array[i], array[j]] = [array[j], array[i]];
     }
 }

 function shuffleDeck() {
     shuffleArray(words);
     generateSlides();
 }

 function generateSlides() {
     const wrapper = document.getElementById("swiperWrapper");
     wrapper.innerHTML = "";

     words.forEach((word, index) => {
         const slide = document.createElement("div");
         slide.className = "swiper-slide";

         slide.innerHTML = `
             <div class="card" onclick="flipCard(this, ${index})">
                 <div class="card-face">
                     <div>
                         <div>${word.english}</div>
                         ${word.description ? `<div class="description">${word.description}</div>` : ""}
          </div>
        </div>
        <div class="card-face card-back">
          <div>
            ${word.japanese ? `<div>${word.japanese}</div>` : ""}
            ${word.romaji ? `<div class="description">${word.romaji}</div>` : ""}
          </div>
        </div>
      </div>
            `;

         wrapper.appendChild(slide);
     });

     if (swiper) swiper.destroy(true, true);

     swiper = new Swiper(".mySwiper", {
         loop: true,
         grabCursor: true,
         on: {
             realIndexChange: function () {
                 updateProgress();

                 document.querySelectorAll(".card").forEach(card => {
                     card.classList.remove("flipped");
                 });

                 triggerAutoFlip();
             }
         }
     });

     updateProgress();
     triggerAutoFlip();
 }

 function flipCard(element, index) {
     // Cancel pending auto flip on manual interaction
     clearTimeout(autoFlipTimeout);

     element.classList.toggle("flipped");

     if (element.classList.contains("flipped")) {
         playAudio();
     }
 }

 function triggerAutoFlip() {
     const delay = parseInt(flipDelaySlider.value);
     if (delay === 0) return;

     clearTimeout(autoFlipTimeout);

     autoFlipTimeout = setTimeout(() => {
         const activeSlide = document.querySelector(".swiper-slide-active .card");
         if (activeSlide && !activeSlide.classList.contains("flipped")) {
             activeSlide.classList.add("flipped");
             playAudio();
         }
     }, delay);
 }

 function updateProgress() {
     if (!words.length) {
         document.getElementById("progress").innerText = "0 / 0";
         return;
     }
     const index = getCurrentIndex();
     document.getElementById("progress").innerText =
         `${index + 1} / ${words.length}`;
 }

 function playAudio() {
     const file = words[getCurrentIndex()]?.audio;
     if (!file) return;

     audioPlayer.pause();
     audioPlayer.src = "audio/" + file;
     audioPlayer.load();
     audioPlayer.play().catch(() => {});
 }
</script>

</body>
</html>
